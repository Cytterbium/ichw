## 详述通用的高速缓存存储器结构及工作原理

高速缓存存储器，又称cache，是提高计算机工作效率以及内存利用率的重要部件。为了理解cache的结构及工作原理，我们要先对整个计算的运行机制有个大致认识。

###CPU的概念

CPU（Central Processing Unit）是微处理器的一种，数据处理速度极快，是计算器最核心的处理部件。简单地说，所有运算均在CPU中进行，这些运算通过CPU中的算术逻辑单元（ALU）、
寄存器组（registers）、
控制单元（control unit）来实现（这些部件在此不作描述）

外存，最常见的外存设备就是硬盘，特点是容量大成本低，但是读写速度很慢。外存通常用来储存需要很长一段时间保存的、重要的数据。

我们可以很清晰地看到，在一个只有外存和CPU的计算机结构中，由于CPU运算速度极快，但是从外存中调入数据时速度相比之下显得非常缓慢，那么势必会出现这样一个问题：绝大多数时间，CPU一直处于等待数据读入的状态。这就好比化学动力学中的绝速步————从硬盘读入数据成为了计算的绝速步，就算后面一个反应速率（CPU处理速度）有多么快，整个反应的速率仍旧限制于绝速步反应的速率。导致计算机整体的效率低下。

于是，便有了内存（Memory）的产生。内存便和我们这次的主题——Cache息息相关了。内存相当于连接CPU和外存的桥梁————内存容量相比外存小很多（现在笔记本电脑通常为8G、16G），但是CPU从内存中读入数据的速度要比CPU从外存中读入数据快很多很多。又由于CPU进行的运算往往是循环式，某些数据的取用将十分频繁，因此当内存中已经包含这些数据时，CPU只需从内存中调用数据即可，从而提高了整体计算速度和效率。

但是这还是不够快！因而有了Cache。通俗地讲，Cache相当于内存的“内存”，容量更小，读入数据能力更快，当然成本也越高。它的工作原理和内存是一致的，就像内存是外存的缓存一样，Cache则是内存的缓存。早先的Cache被设计在CPU中，我们可以打个比方————巨大的图书馆中，图书管理员坐在一张小书桌前做摘记，身上背了个书包。假设书桌只能放三本书，书包可以放20本书。那么我们可以说，书就相当于计算机中储存的数据（块），图书馆馆藏总和相当于外存，背包相当于内存，书桌就相当于Cache，图书管理员就是CPU，他做摘记的行为就相当于CPU在处理数据。最理想的情况就是管理员想要的书就是书桌上三本书之一，次理想的情况是被需要的书在书包中，最不理想的情况就是管理员发现身边（Cache 和Memory）中都没有想要的书，就得起身搜寻整个图书馆。

这就涉及到命中和不命中的概念，上文提到过，由于计算机程序的循环特性，若第一次不命中，多费点事儿后，之后对该数据的调用就都可命中，所以整体上看，缓存的引入大大提高了计算效率（尽管有不命中的概率）。值得一提的是，CPU到Cache的命中率往往在80%左右，在现代计算机中，Cache又细化为二级乃至三级结构，因此整体Cache的命中率大大提高。很显然，命中率的高低与Cache从内存中提取数据的策略有关。最容易理解的例子当一次不命中发生后，Cache（假定容量已满）从内存读入的新数据替换Cache中最不常用的数据，这样提高了Cache中数据的使用频率，也就提高了下一次命中的概率。当然，实际上替换数据的算法是非常复杂的，但目的都是为了提高大样本下的命中率，以此来提高计算机处理数据的速度。

Cache是由许多条Cache line组成的，Cache line可以理解成CPU寻找数据的线索。打个比方，伯乐相马这个故事在计算机领域中可以这么描述，伯乐（CPU）正在寻找一匹良马（data wanted），他手中有一张图（Cache），图上是一条条线索（Cache line）。为什么伯乐通过线索可以正确找出良马呢？就是因为每一条线索都正确地指向了特定的一匹马。在计算机中，如何正确地使CPU通过Cache line找出 wanted Data是一个值得思考的问题。

已知内存中的数据是一条条储存的，并有各自的地址（包括tag，index和block）。而在Cache中，对每一条Cache line而言，它往往储存的是数据块（提高命中率），也有tag（指明数据块在内存的何处）。这样，当CPU要读取数据，先向Cache发出请求，Cache搜索一遍自身并发现有一条Cache line的tag符合，那么Cache就用line的地址跳转到该数据所在的数据块中，再根据更详细的地址找出数据块中的数据。当然 ，以上讲述是根据直接映射展开的，还有其他Cache结构的思想比如组相联、全相连等等，实际上更加有效，总之目的都是如何让存储空间小的Cache所
已知内存中的数据是一条条储存的，并有各自的地址（包括tag，index和block）。而在Cache中，对每一条Cache line而言，它往往储存的是数据块（提高命中率），也有tag（指明数据块在内存的何处）。这样，当CPU要读取数据，先向Cache发出请求，Cache搜索一遍自身并发现有一条Cache line的tag符合，那么Cache就用line的地址跳转到该数据所在的数据块中，再根据更详细的地址找出数据块中的数据。当然 ，以上讲述是根据直接映射展开的，还有其他Cache结构的思想比如组相联、全相连等等，实际上更加有效，总之目的都是如何让存储空间小的Cache，存储的数据被命中概率尽可能大。
